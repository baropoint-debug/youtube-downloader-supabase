<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Downloader - Supabase</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* 세련된 디자인 */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .btn {
            border-radius: 25px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }
        
        .btn-outline-primary {
            border: 2px solid #667eea;
            color: #667eea;
        }
        
        .btn-outline-primary:hover {
            background: #667eea;
            color: white;
        }
        
        .form-control {
            border-radius: 25px;
            border: 2px solid #e9ecef;
            padding: 20px 30px;
            font-size: 18px;
            height: 60px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .video-item {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .video-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .video-item .card-body {
            padding: 20px;
        }
        
        .video-item img {
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .video-item:hover img {
            transform: scale(1.05);
        }
        
        .badge {
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .loading {
            padding: 40px;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }
            
            .card {
                margin: 10px 0;
                padding: 15px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .input-group input {
                border-radius: 25px !important;
                margin-bottom: 10px;
            }
            
            .input-group button {
                border-radius: 25px !important;
                width: 100%;
            }
            
            .btn-group {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .btn {
                margin-bottom: 5px;
                border-radius: 25px;
            }
            
            .row {
                margin: 0;
            }
            
            .col-md-6 {
                padding: 5px;
            }
            
            .video-item .row {
                flex-direction: column;
            }
            
            .video-item .col-md-3,
            .video-item .col-md-7,
            .video-item .col-md-2 {
                width: 100%;
                margin-bottom: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .form-control {
                font-size: 20px;
                padding: 25px 35px;
                height: 70px;
                border-radius: 35px;
            }
            
            .btn {
                padding: 20px 30px;
                font-size: 18px;
                height: 70px;
                border-radius: 35px;
            }
            
            .input-group {
                margin-bottom: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .card {
                margin: 5px 0;
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .form-control {
                font-size: 22px;
                padding: 30px 40px;
                height: 80px;
                border-radius: 40px;
            }
            
            .btn {
                padding: 25px 35px;
                font-size: 20px;
                height: 80px;
                border-radius: 40px;
            }
            
            .input-group {
                margin-bottom: 25px;
            }
            
            .input-group input {
                font-size: 22px;
                padding: 30px 40px;
                height: 80px;
                border-radius: 40px;
            }
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: none;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
        }
        .video-card {
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            background: white;
        }
        .video-card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transform: translateY(-3px);
        }
        .video-thumbnail {
            width: 120px;
            height: 90px;
            object-fit: cover;
            border-radius: 10px;
        }
        .user-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        .loading {
            display: none;
        }
        .alert {
            border-radius: 15px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- 헤더 -->
        <div class="text-center mb-5">
            <h1 class="display-4 text-white mb-3">
                <i class="fab fa-youtube text-danger me-3"></i>
                YouTube Downloader
            </h1>
            <p class="lead text-white-50">Supabase 기반 클라우드 다운로더</p>
        </div>

        <!-- 사용자 관리 섹션 -->
        <div class="user-section">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div id="userInfo" style="display: none;">
                        <div class="d-flex align-items-center text-white">
                            <i class="fas fa-user-circle me-3" style="font-size: 2rem;"></i>
                            <div>
                                <div class="fw-bold" id="userName">사용자명</div>
                                <small id="userEmail">user@example.com</small>
                            </div>
                        </div>
                    </div>
                    <div id="loginForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <input type="email" id="userEmailInput" class="form-control mb-3" 
                                           placeholder="이메일을 입력하세요">
                                </div>
                                <div class="mb-3">
                                    <input type="password" id="userPasswordInput" class="form-control mb-3" 
                                           placeholder="비밀번호를 입력하세요">
                                </div>
                                <div class="mb-3">
                                    <button class="btn btn-primary w-100" type="button" onclick="loginUser()">
                                        <i class="fas fa-sign-in-alt me-2"></i>로그인
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-white">
                                    <small>사전 등록된 사용자만 로그인 가능</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-light btn-sm" onclick="showUserHistory()" id="historyBtn" disabled>
                            <i class="fas fa-history me-1"></i>히스토리
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="showUserFavorites()" id="favoritesBtn" disabled>
                            <i class="fas fa-star me-1"></i>즐겨찾기
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="showSettings()" id="settingsBtn" disabled>
                            <i class="fas fa-cog me-1"></i>설정
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="logoutUser()" id="logoutBtn" style="display: none;">
                            <i class="fas fa-sign-out-alt me-1"></i>로그아웃
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 메인 검색 섹션 -->
        <div class="card mb-4">
            <div class="card-body p-4">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" id="searchInput" class="form-control" 
                                   placeholder="유튜브 URL 또는 검색어를 입력하세요...">
                            <button class="btn btn-primary" type="button" onclick="searchVideos()">
                                <i class="fas fa-search me-2"></i>검색
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-success w-100" onclick="downloadSelected()">
                            <i class="fas fa-download me-2"></i>선택 다운로드
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 로딩 표시 -->
        <div class="loading text-center" id="loadingSection">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">로딩 중...</span>
            </div>
            <p class="mt-2 text-white">검색 중입니다...</p>
        </div>

        <!-- 결과 섹션 -->
        <div class="card" id="resultsSection" style="display: none;">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">
                        <i class="fas fa-list me-2"></i>검색 결과
                        <span class="badge bg-primary ms-2" id="resultCount">0</span>
                    </h3>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-success btn-sm" onclick="selectAllVideos()">
                            <i class="fas fa-check-square me-1"></i>전체 선택
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="deselectAllVideos()">
                            <i class="fas fa-square me-1"></i>전체 해제
                        </button>
                    </div>
                </div>
                
                <!-- 정렬 옵션 -->
                <div class="mb-3">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary btn-sm" onclick="changeSortOrder('relevance')">
                            <i class="fas fa-star me-1"></i>관련성
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="changeSortOrder('duration-asc')">
                            <i class="fas fa-arrow-up me-1"></i>시간 짧은 순
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="changeSortOrder('duration-desc')">
                            <i class="fas fa-arrow-down me-1"></i>시간 긴 순
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="changeSortOrder('viewCount')">
                            <i class="fas fa-eye me-1"></i>조회수 순
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="changeSortOrder('date')">
                            <i class="fas fa-calendar me-1"></i>최신순
                        </button>
                    </div>
                </div>
                <div id="videoResults"></div>
                
                <!-- 페이징 컨테이너 -->
                <div id="paginationContainer" class="mt-4"></div>
            </div>
        </div>

        <!-- 알림 메시지 -->
        <div id="alertContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Supabase 설정
        const SUPABASE_URL = 'https://qhrfefcthrogwdwpxkby.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFocmZlZmN0aHJvZ3dkd3B4a2J5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTg1ODUsImV4cCI6MjA3NTM5NDU4NX0.Do9gajWdwgP8PFSlajAUhZHb024nfNZNnx1IJz9yR5k'
        
        // 전역 변수
        let selectedVideos = new Set()
        let currentUser = null
        let searchResults = []
        let currentSortOrder = 'relevance' // 기본값: 관련성
        let currentPage = 1
        let currentQuery = ''
        let paginationInfo = null
        
        // 사용자 설정 (로컬 스토리지에서 불러오기)
        let userSettings = {
            defaultQuality: '720p', // 기본 다운로드 품질
            autoDownload: false,    // 자동 다운로드 (모바일)
            showQualityDialog: true, // 품질 선택 다이얼로그 표시 여부
            downloadPath: '',       // 다운로드 경로 (브라우저 기본값 사용)
            askDownloadPath: false  // 다운로드 시 경로 묻기
        }

        // 사용자 로그인
        async function loginUser() {
            const email = document.getElementById('userEmailInput').value.trim()
            
            if (!email) {
                showAlert('이메일을 입력해주세요.', 'warning')
                return
            }
            
            try {
                const result = await callSupabaseAPI('/user/login', 'POST', { email, password: document.getElementById('userPasswordInput').value })
                
                if (result.success) {
                    currentUser = result.user
                    updateUserInterface()
                    showAlert(`환영합니다, ${result.user.name}님!`, 'success')
                } else {
                    showAlert(result.error || '로그인에 실패했습니다.', 'error')
                }
            } catch (error) {
                console.error('Login error:', error)
                showAlert('로그인 중 오류가 발생했습니다.', 'error')
            }
        }
        
        // 설정 불러오기
        function loadUserSettings() {
            const saved = localStorage.getItem('youtubeDownloaderSettings')
            if (saved) {
                userSettings = { ...userSettings, ...JSON.parse(saved) }
            }
        }
        
        // 설정 저장
        function saveUserSettings() {
            localStorage.setItem('youtubeDownloaderSettings', JSON.stringify(userSettings))
        }
        
        // 설정 화면 표시
        function showSettings() {
            loadUserSettings()
            
            const settingsHtml = `
                <div class="modal fade" id="settingsModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-cog me-2"></i>다운로드 설정
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">기본 다운로드 품질</label>
                                    <select class="form-select" id="defaultQuality">
                                        <option value="720p" ${userSettings.defaultQuality === '720p' ? 'selected' : ''}>720p (HD) - 추천</option>
                                        <option value="480p" ${userSettings.defaultQuality === '480p' ? 'selected' : ''}>480p (SD) - 데이터 절약</option>
                                        <option value="360p" ${userSettings.defaultQuality === '360p' ? 'selected' : ''}>360p (낮은 품질)</option>
                                        <option value="audio" ${userSettings.defaultQuality === 'audio' ? 'selected' : ''}>Audio (음성만)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="autoDownload" ${userSettings.autoDownload ? 'checked' : ''}>
                                        <label class="form-check-label" for="autoDownload">
                                            📱 모바일에서 자동 다운로드 (품질 선택 없이)
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showQualityDialog" ${userSettings.showQualityDialog ? 'checked' : ''}>
                                        <label class="form-check-label" for="showQualityDialog">
                                            품질 선택 다이얼로그 표시
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">다운로드 경로 설정</label>
                                    <div class="alert alert-success">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <strong>서버 사이드 다운로드:</strong> 이제 서버에서 직접 다운로드하므로 폴더를 지정할 수 있습니다!
                                    </div>
                                    <div class="mb-3">
                                        <label for="downloadPath" class="form-label">다운로드 폴더 경로</label>
                                        <input type="text" class="form-control" id="downloadPath" 
                                               placeholder="예: C:\Downloads\YouTube" 
                                               value="${userSettings.downloadPath || ''}">
                                        <div class="form-text">
                                            <strong>Windows:</strong> C:\Downloads\YouTube<br>
                                            <strong>Mac:</strong> /Users/username/Downloads/YouTube<br>
                                            <strong>Linux:</strong> /home/username/Downloads/YouTube
                                        </div>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="askDownloadPath" ${userSettings.askDownloadPath ? 'checked' : ''}>
                                        <label class="form-check-label" for="askDownloadPath">
                                            다운로드 시 경로 확인 메시지 표시
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>모바일 최적화:</strong> 자동 다운로드를 활성화하면 모바일에서 품질 선택 없이 바로 다운로드됩니다.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                <button type="button" class="btn btn-primary" onclick="saveSettings()">저장</button>
                            </div>
                        </div>
                    </div>
                </div>
            `
            
            // 기존 모달 제거
            const existingModal = document.getElementById('settingsModal')
            if (existingModal) {
                existingModal.remove()
            }
            
            // 새 모달 추가
            document.body.insertAdjacentHTML('beforeend', settingsHtml)
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('settingsModal'))
            modal.show()
        }
        
        // 설정 저장
        function saveSettings() {
            userSettings.defaultQuality = document.getElementById('defaultQuality').value
            userSettings.autoDownload = document.getElementById('autoDownload').checked
            userSettings.showQualityDialog = document.getElementById('showQualityDialog').checked
            userSettings.askDownloadPath = document.getElementById('askDownloadPath').checked
            userSettings.downloadPath = document.getElementById('downloadPath').value
            
            saveUserSettings()
            
            // 모달 닫기
            const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'))
            modal.hide()
            
            showAlert('설정이 저장되었습니다.', 'success')
        }
        
        // ISO 8601 duration을 초로 변환
        function parseDuration(duration) {
            const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/)
            if (!match) return 0
            
            const hours = (match[1] || '0H').replace('H', '')
            const minutes = (match[2] || '0M').replace('M', '')
            const seconds = (match[3] || '0S').replace('S', '')
            
            return parseInt(hours) * 3600 + parseInt(minutes) * 60 + parseInt(seconds)
        }
        
        // 초를 "HH:MM:SS" 또는 "MM:SS" 형식으로 변환
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600)
            const minutes = Math.floor((seconds % 3600) / 60)
            const secs = seconds % 60
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`
            }
        }
        
        // 조회수 포맷
        function formatViewCount(count) {
            if (count >= 100000000) return `${(count / 100000000).toFixed(1)}억`
            if (count >= 10000) return `${(count / 10000).toFixed(1)}만`
            return count.toLocaleString()
        }

        // Supabase Edge Function API 호출
        async function callSupabaseAPI(endpoint, method = 'GET', data = null) {
            // Edge Function 이름: 'youtube-downloader' 또는 실제 배포된 함수 이름으로 변경
            const functionName = 'youtube-downloader' // ← Supabase 대시보드에서 확인한 실제 함수 이름
            const url = `${SUPABASE_URL}/functions/v1/${functionName}${endpoint}`
            
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            }
            
            if (data) {
                options.body = JSON.stringify(data)
            }
            
            try {
                const response = await fetch(url, options)
                const result = await response.json()
                
                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}`)
                }
                
                return result
            } catch (error) {
                console.error('API 호출 오류:', error)
                return { error: error.message }
            }
        }

        // YouTube 검색
        async function searchVideos() {
            const query = document.getElementById('searchInput').value.trim()
            
            if (!query) {
                showAlert('검색어를 입력해주세요.', 'warning')
                return
            }
            
            showLoading(true)
            
            try {
                const result = await callSupabaseAPI('/search', 'POST', { query })
                
                if (result.success) {
                    displaySearchResults(result.videos)
                    showAlert(`${result.videos.length}개의 결과를 찾았습니다.`, 'success')
                } else {
                    showAlert(result.error || '검색 중 오류가 발생했습니다.', 'error')
                }
            } catch (error) {
                showAlert('검색 중 오류가 발생했습니다.', 'error')
            } finally {
                showLoading(false)
            }
        }

        // 검색 결과 표시
        function displaySearchResults(videos) {
            const resultsContainer = document.getElementById('videoResults')
            const resultCount = document.getElementById('resultCount')
            
            resultCount.textContent = videos.length
            
            resultsContainer.innerHTML = videos.map(video => `
                <div class="video-item card mb-3" data-video-id="${video.id}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <img src="${video.thumbnail}" class="img-fluid rounded" alt="${video.title}">
                            </div>
                            <div class="col-md-7">
                                <h5 class="card-title">${video.title}</h5>
                                <p class="card-text text-muted">${video.channel}</p>
                                <p class="card-text small">${video.description.substring(0, 100)}...</p>
                            </div>
                            <div class="col-md-2 text-end">
                                <div class="form-check mb-2">
                                    <input class="form-check-input video-checkbox" type="checkbox" value="${video.id}">
                                    <label class="form-check-label">선택</label>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" onclick="downloadSingleVideo('${video.id}', '${video.title}')">
                                    <i class="fas fa-download me-1"></i>다운로드
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')
            
            document.getElementById('resultsSection').style.display = 'block'
        }

        // 단일 비디오 다운로드
        async function downloadSingleVideo(videoId, title) {
            try {
                showAlert(`${title} 다운로드를 시작합니다...`, 'info')
                
                // 다운로드 링크 생성
                const result = await callSupabaseAPI('/download-links', 'POST', { videoId })
                
                if (result.success) {
                    // 클라이언트 사이드 다운로드 처리
                    await handleClientDownload(videoId, title, result.downloadLinks)
                } else {
                    showAlert(result.error || '다운로드 링크 생성에 실패했습니다.', 'error')
                }
            } catch (error) {
                showAlert('다운로드 중 오류가 발생했습니다.', 'error')
            }
        }

        // 클라이언트 사이드 다운로드 처리
        async function handleClientDownload(videoId, title, downloadLinks) {
            try {
                // 모바일 기기 감지
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                
                // 설정 불러오기
                loadUserSettings()
                
                let format
                
                if (isMobile && userSettings.autoDownload) {
                    // 모바일 + 자동 다운로드 설정 시
                    format = userSettings.defaultQuality
                    showAlert(`📱 모바일 최적화: ${format} 품질로 다운로드합니다.`, 'info')
                } else if (userSettings.showQualityDialog) {
                    // 품질 선택 다이얼로그 표시
                    format = await showDownloadOptions()
                    
                    if (!format) {
                        showAlert('다운로드가 취소되었습니다.', 'info')
                        return
                    }
                } else {
                    // 기본 품질 사용
                    format = userSettings.defaultQuality
                    showAlert(`${format} 품질로 다운로드합니다.`, 'info')
                }
                
                // 다운로드 링크 생성 (실제로는 yt-dlp.js 또는 다른 방법 사용)
                const downloadUrl = await generateDownloadUrl(videoId, format)
                
                if (downloadUrl) {
                    // 브라우저 다운로드 시작
                    startBrowserDownload(downloadUrl, title, format)
                    showAlert(`${title} 다운로드가 시작되었습니다.`, 'success')
                } else {
                    showAlert('다운로드 링크를 생성할 수 없습니다.', 'error')
                }
                
            } catch (error) {
                console.error('Download error:', error)
                showAlert('다운로드 중 오류가 발생했습니다.', 'error')
            }
        }

        // 다운로드 옵션 선택 (모바일 최적화)
        function showDownloadOptions() {
            return new Promise((resolve) => {
                // 모바일 기기 감지
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                
                if (isMobile) {
                    // 모바일에서는 720p를 기본으로 추천
                    const message = `📱 모바일 최적화 다운로드 품질을 선택하세요:

⭐ 1. 720p (HD) - 추천
  2. 480p (SD) - 데이터 절약  
  3. 360p (낮은 품질) - 빠른 다운로드
  4. Audio (음성만)

💡 추천: 720p (모바일에서 가장 적합)

번호를 입력하세요 (1-4, 엔터=720p):`
                    
                    const choice = prompt(message)
                    
                    if (choice === '' || choice === null) {
                        // 엔터만 누르면 720p 기본 선택
                        resolve('720p')
                    } else if (choice >= 1 && choice <= 4) {
                        const options = ['720p', '480p', '360p', 'audio']
                        resolve(options[choice - 1])
                    } else {
                        // 잘못된 입력이면 720p 기본 선택
                        resolve('720p')
                    }
                } else {
                    // 데스크톱에서는 기존 방식
                    const choice = prompt(`다운로드 품질을 선택하세요:\n1. 720p\n2. 480p\n3. 360p\n4. Audio\n\n번호를 입력하세요 (1-4):`)
                    
                    if (choice && choice >= 1 && choice <= 4) {
                        const options = ['720p', '480p', '360p', 'audio']
                        resolve(options[choice - 1])
                    } else {
                        resolve(null)
                    }
                }
            })
        }

        // 다운로드 URL 생성 (실제 구현에서는 yt-dlp.js 사용)
        async function generateDownloadUrl(videoId, format) {
            try {
                // 실제로는 yt-dlp.js 또는 다른 방법을 사용해야 함
                // 여기서는 예시로 YouTube URL을 반환
                const youtubeUrl = `https://www.youtube.com/watch?v=${videoId}`
                
                // yt-dlp.js를 사용한 다운로드 URL 생성
                // 이 부분은 실제 yt-dlp.js 라이브러리 사용 필요
                
                return youtubeUrl
            } catch (error) {
                console.error('URL generation error:', error)
                return null
            }
        }

        // 브라우저 다운로드 시작 (개선된 버전)
        function startBrowserDownload(url, title, format) {
            try {
                // 파일명 생성 (특수문자 제거)
                const cleanTitle = title.replace(/[^\w\s-가-힣]/g, '').replace(/\s+/g, '_')
                const extension = format === 'audio' ? 'mp3' : 'mp4'
                const filename = `${cleanTitle}.${extension}`
                
                // 다운로드 링크 생성
                const a = document.createElement('a')
                a.href = url
                a.download = filename
                a.style.display = 'none'
                
                // DOM에 추가하고 클릭
                document.body.appendChild(a)
                a.click()
                document.body.removeChild(a)
                
                // 서버 사이드 다운로드로 변경
                startServerDownload(videoId, title, format)
                
            } catch (error) {
                console.error('Download start error:', error)
                showAlert('다운로드를 시작할 수 없습니다.', 'error')
            }
        }

        // 서버 사이드 다운로드 시작
        async function startServerDownload(videoId, title, format) {
            try {
                // 설정 불러오기
                loadUserSettings()
                
                // 서버에 다운로드 요청
                const response = await callSupabaseAPI('/download', 'POST', {
                    videoId: videoId,
                    format: format,
                    downloadPath: userSettings.downloadPath || ''
                })
                
                if (response.success) {
                    // 다운로드 성공
                    addToDownloadHistory(title, `https://www.youtube.com/watch?v=${videoId}`, format)
                    
                    if (userSettings.askDownloadPath) {
                        showAlert(`📁 ${title} 다운로드가 완료되었습니다!\n\n💾 저장 위치: ${response.downloadPath || '기본 폴더'}\n\n✅ 서버에서 직접 다운로드하여 지정한 폴더에 저장되었습니다.`, 'success')
                    } else {
                        showAlert(`📁 ${title} 다운로드가 완료되었습니다!`, 'success')
                    }
                } else {
                    showAlert(`다운로드 실패: ${response.error}`, 'error')
                }
                
            } catch (error) {
                console.error('Server download error:', error)
                showAlert('서버 다운로드 중 오류가 발생했습니다.', 'error')
            }
        }

        // 다운로드 히스토리에 추가
        function addToDownloadHistory(title, url, format) {
            const history = JSON.parse(localStorage.getItem('downloadHistory') || '[]')
            history.unshift({
                title,
                url,
                format,
                timestamp: new Date().toISOString()
            })
            
            // 최대 100개까지만 저장
            if (history.length > 100) {
                history.splice(100)
            }
            
            localStorage.setItem('downloadHistory', JSON.stringify(history))
        }



        // 사용자 로그아웃
        function logoutUser() {
            currentUser = null
            updateUserInterface()
            showAlert('로그아웃되었습니다.', 'info')
        }

        // 사용자 인터페이스 업데이트
        function updateUserInterface() {
            const userInfo = document.getElementById('userInfo')
            const loginForm = document.getElementById('loginForm')
            const userName = document.getElementById('userName')
            const userEmail = document.getElementById('userEmail')
            const historyBtn = document.getElementById('historyBtn')
            const favoritesBtn = document.getElementById('favoritesBtn')
            const logoutBtn = document.getElementById('logoutBtn')
            
            if (currentUser) {
                userInfo.style.display = 'block'
                loginForm.style.display = 'none'
                userName.textContent = currentUser.name
                userEmail.textContent = currentUser.email
                historyBtn.disabled = false
                favoritesBtn.disabled = false
                logoutBtn.style.display = 'inline-block'
            } else {
                userInfo.style.display = 'none'
                loginForm.style.display = 'block'
                historyBtn.disabled = true
                favoritesBtn.disabled = true
                logoutBtn.style.display = 'none'
            }
        }

        // 정렬 및 결과 표시
        function sortAndDisplayResults() {
            let sortedVideos = [...searchResults]
            
            switch(currentSortOrder) {
                case 'duration-asc': // 시간 짧은 순
                    sortedVideos.sort((a, b) => a.durationSeconds - b.durationSeconds)
                    break
                case 'duration-desc': // 시간 긴 순
                    sortedVideos.sort((a, b) => b.durationSeconds - a.durationSeconds)
                    break
                case 'viewCount': // 조회수 높은 순
                    sortedVideos.sort((a, b) => b.view_count - a.view_count)
                    break
                case 'date': // 최신순
                    sortedVideos.sort((a, b) => new Date(b.publishedAt || 0) - new Date(a.publishedAt || 0))
                    break
                case 'relevance': // 관련성 (기본값)
                default:
                    // API가 반환한 순서 유지
                    break
            }
            
            displayResults(sortedVideos)
        }
        
        // 정렬 순서 변경
        function changeSortOrder(order) {
            currentSortOrder = order
            sortAndDisplayResults()
        }
        
        // 페이지 변경
        async function changePage(page) {
            if (!currentQuery) return
            
            showLoading(true)
            try {
                const result = await callSupabaseAPI('/search', 'POST', { 
                    query: currentQuery, 
                    page: page, 
                    pageSize: 10 
                })
                
                if (result.success && result.videos) {
                    const videos = result.videos.map(video => ({
                        title: video.title,
                        duration: video.duration || 'PT0S',
                        durationSeconds: parseDuration(video.duration || 'PT0S'),
                        url: video.url,
                        thumbnail: video.thumbnail,
                        channel_title: video.channel,
                        view_count: video.viewCount || 0,
                        like_count: video.likeCount || 0,
                        comment_count: video.commentCount || 0,
                        id: video.id,
                        description: video.description
                    }))
                    
                    searchResults = videos
                    paginationInfo = result.pagination
                    currentPage = page
                    sortAndDisplayResults()
                    updatePaginationUI()
                } else {
                    showAlert(result.error || '페이지 로드에 실패했습니다.', 'danger')
                }
            } catch (error) {
                console.error('Page change error:', error)
                showAlert('페이지 로드 중 오류가 발생했습니다: ' + error.message, 'danger')
            } finally {
                showLoading(false)
            }
        }
        
        // 페이징 UI 업데이트
        function updatePaginationUI() {
            const paginationContainer = document.getElementById('paginationContainer')
            if (!paginationInfo || !paginationContainer) return
            
            let html = '<nav aria-label="검색 결과 페이지"><ul class="pagination justify-content-center">'
            
            // 이전 페이지 버튼
            if (paginationInfo.hasPrevPage) {
                html += `<li class="page-item">
                    <button class="page-link" onclick="changePage(${currentPage - 1})">
                        <i class="fas fa-chevron-left"></i> 이전
                    </button>
                </li>`
            } else {
                html += `<li class="page-item disabled">
                    <span class="page-link"><i class="fas fa-chevron-left"></i> 이전</span>
                </li>`
            }
            
            // 페이지 번호들
            const startPage = Math.max(1, currentPage - 2)
            const endPage = Math.min(Math.ceil(paginationInfo.totalResults / paginationInfo.pageSize), currentPage + 2)
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    html += `<li class="page-item active">
                        <span class="page-link">${i}</span>
                    </li>`
                } else {
                    html += `<li class="page-item">
                        <button class="page-link" onclick="changePage(${i})">${i}</button>
                    </li>`
                }
            }
            
            // 다음 페이지 버튼
            if (paginationInfo.hasNextPage) {
                html += `<li class="page-item">
                    <button class="page-link" onclick="changePage(${currentPage + 1})">
                        다음 <i class="fas fa-chevron-right"></i>
                    </button>
                </li>`
            } else {
                html += `<li class="page-item disabled">
                    <span class="page-link">다음 <i class="fas fa-chevron-right"></i></span>
                </li>`
            }
            
            html += '</ul></nav>'
            
            // 총 결과 수 표시
            html += `<div class="text-center mt-2">
                <small class="text-muted">
                    총 ${paginationInfo.totalResults.toLocaleString()}개 중 
                    ${((currentPage - 1) * paginationInfo.pageSize) + 1}-${Math.min(currentPage * paginationInfo.pageSize, paginationInfo.totalResults)}개 표시
                </small>
            </div>`
            
            paginationContainer.innerHTML = html
        }
        
        // URL인지 검색어인지 판단
        function isYouTubeUrl(text) {
            const patterns = [
                /^https?:\/\/(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)/,
                /^https?:\/\/youtube\.com\/watch\?.*v=/,
                /^https?:\/\/youtu\.be\//
            ]
            return patterns.some(pattern => pattern.test(text))
        }
        
        // URL에서 비디오 ID 추출
        function extractVideoIdFromUrl(url) {
            try {
                const patterns = [
                    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
                    /youtube\.com\/watch\?.*v=([^&\n?#]+)/
                ]
                
                for (const pattern of patterns) {
                    const match = url.match(pattern)
                    if (match && match[1]) {
                        return match[1]
                    }
                }
                
                return null
            } catch (error) {
                console.error('Extract video ID error:', error)
                return null
            }
        }

        // 비디오 검색
        async function searchVideos() {
            const query = document.getElementById('searchInput').value.trim()
            
            if (!query) {
                showAlert('검색어 또는 URL을 입력해주세요.', 'warning')
                return
            }

            if (!currentUser) {
                showAlert('로그인이 필요합니다.', 'warning')
                return
            }

            showLoading(true)
            selectedVideos.clear()
            
            try {
                // URL인지 검색어인지 판단
                if (isYouTubeUrl(query)) {
                    // URL 검색 - 단일 비디오 정보 가져오기
                    await searchByUrl(query)
                } else {
                    // 검색어 검색 - 여러 결과
                    await searchByQuery(query)
                }
            } catch (error) {
                console.error('Search error:', error)
                showAlert('검색 중 오류가 발생했습니다: ' + error.message, 'danger')
                displayResults([])
            } finally {
                showLoading(false)
            }
        }
        
        // URL로 검색 (단일 비디오)
        async function searchByUrl(url) {
            try {
                const result = await callSupabaseAPI('/video-info', 'POST', { url })
                
                if (result.success && result.video) {
                    const video = result.video
                    const videoData = {
                        title: video.title,
                        duration: video.duration || 'PT0S',
                        durationSeconds: parseDuration(video.duration || 'PT0S'),
                        url: video.url,
                        thumbnail: video.thumbnail,
                        channel_title: video.channel,
                        view_count: video.viewCount || 0,
                        like_count: video.likeCount || 0,
                        comment_count: video.commentCount || 0,
                        id: video.id,
                        description: video.description
                    }
                    
                    searchResults = [videoData] // 단일 결과
                    paginationInfo = {
                        currentPage: 1,
                        pageSize: 1,
                        totalResults: 1,
                        hasNextPage: false,
                        hasPrevPage: false
                    }
                    currentPage = 1
                    currentQuery = url
                    
                    displayResults([videoData])
                    updatePaginationUI()
                    showAlert('비디오 정보를 가져왔습니다.', 'success')
                } else {
                    showAlert(result.error || '비디오 정보를 가져올 수 없습니다.', 'danger')
                    displayResults([])
                }
            } catch (error) {
                console.error('URL search error:', error)
                showAlert('URL 검색 중 오류가 발생했습니다: ' + error.message, 'danger')
                displayResults([])
            }
        }
        
        // 검색어로 검색 (여러 결과)
        async function searchByQuery(query) {
            try {
                currentQuery = query
                currentPage = 1
                const result = await callSupabaseAPI('/search', 'POST', { query, page: 1, pageSize: 10 })
                
                if (result.success && result.videos) {
                    // API 응답 형식을 displayResults 함수에 맞게 변환
                    const videos = result.videos.map(video => ({
                        title: video.title,
                        duration: video.duration || 'PT0S', // ISO 8601 형식
                        durationSeconds: parseDuration(video.duration || 'PT0S'), // 정렬용
                        url: video.url,
                        thumbnail: video.thumbnail,
                        channel_title: video.channel,
                        view_count: video.viewCount || 0, // 숫자로 저장
                        like_count: video.likeCount || 0, // 좋아요 수
                        comment_count: video.commentCount || 0, // 댓글 수
                        id: video.id,
                        description: video.description
                    }))
                    
                    searchResults = videos
                    paginationInfo = result.pagination
                    sortAndDisplayResults()
                    updatePaginationUI()
                    showAlert(`${videos.length}개의 결과를 찾았습니다.`, 'success')
                } else {
                    showAlert(result.error || '검색에 실패했습니다.', 'danger')
                    displayResults([])
                }
            } catch (error) {
                console.error('Search error:', error)
                showAlert('검색 중 오류가 발생했습니다: ' + error.message, 'danger')
                displayResults([])
            }
        }

        // 결과 표시
        function displayResults(results) {
            const videoResults = document.getElementById('videoResults')
            const resultCount = document.getElementById('resultCount')
            
            resultCount.textContent = results.length
            
            if (results.length === 0) {
                videoResults.innerHTML = '<p class="text-muted text-center">검색 결과가 없습니다.</p>'
                return
            }

            let html = ''
            results.forEach((video, index) => {
                const isSelected = selectedVideos.has(video.url)
                
                html += `
                    <div class="video-card">
                        <div class="row align-items-center">
                            <div class="col-md-1">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="video${index}" value="${video.url}"
                                           ${isSelected ? 'checked' : ''}
                                           onchange="toggleVideoSelection('${video.url}')">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <img src="${video.thumbnail}" alt="썸네일" class="video-thumbnail">
                            </div>
                            <div class="col-md-7">
                                <h5 class="mb-2">${video.title}</h5>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-user me-2"></i>${video.channel_title}
                                        </p>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-clock me-2"></i>${formatDuration(video.durationSeconds)}
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-eye me-2"></i>${formatViewCount(video.view_count)} 조회
                                        </p>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-thumbs-up me-2"></i>${formatViewCount(video.like_count)} 좋아요
                                        </p>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-comments me-2"></i>${formatViewCount(video.comment_count)} 댓글
                                        </p>
                                    </div>
                                </div>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-link me-2"></i>
                                    <a href="${video.url}" target="_blank" class="text-decoration-none">
                                        ${video.url}
                                    </a>
                                </p>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-outline-primary btn-sm" 
                                        onclick="downloadSingle('${video.url}')">
                                    <i class="fas fa-download me-1"></i>다운로드
                                </button>
                            </div>
                        </div>
                    </div>
                `
            })
            
            videoResults.innerHTML = html
            updateSelectionStatus()
        }

        // 비디오 선택 토글
        function toggleVideoSelection(url) {
            if (selectedVideos.has(url)) {
                selectedVideos.delete(url)
            } else {
                selectedVideos.add(url)
            }
            updateSelectionStatus()
        }

        // 선택 상태 업데이트
        function updateSelectionStatus() {
            const selectedCount = selectedVideos.size
            const totalCount = document.querySelectorAll('input[type="checkbox"][id^="video"]').length
            
            const resultCount = document.getElementById('resultCount')
            if (selectedCount > 0) {
                resultCount.textContent = `${selectedCount}/${totalCount}`
                resultCount.className = 'badge bg-success ms-2'
            } else {
                resultCount.textContent = totalCount
                resultCount.className = 'badge bg-primary ms-2'
            }
        }

        // 전체 선택
        function selectAllVideos() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="video"]')
            checkboxes.forEach(checkbox => {
                if (checkbox.value) {
                    selectedVideos.add(checkbox.value)
                    checkbox.checked = true
                }
            })
            updateSelectionStatus()
            showAlert(`${checkboxes.length}개 비디오가 선택되었습니다.`, 'success')
        }

        // 전체 해제
        function deselectAllVideos() {
            selectedVideos.clear()
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="video"]')
            checkboxes.forEach(checkbox => {
                checkbox.checked = false
            })
            updateSelectionStatus()
            showAlert('모든 선택이 해제되었습니다.', 'info')
        }

        // 선택된 비디오 다운로드
        async function downloadSelected() {
            if (selectedVideos.size === 0) {
                showAlert('다운로드할 비디오를 선택해주세요.', 'warning')
                return
            }

            const urls = Array.from(selectedVideos)
            await downloadVideos(urls)
        }

        // 단일 비디오 다운로드
        async function downloadSingle(url) {
            await downloadVideos([url])
        }

        // 비디오 다운로드 (클라이언트 사이드)
        async function downloadVideos(urls) {
            if (!currentUser) {
                showAlert('로그인이 필요합니다.', 'warning')
                return
            }

            if (urls.length === 0) {
                showAlert('다운로드할 비디오를 선택해주세요.', 'warning')
                return
            }

            try {
                showAlert(`${urls.length}개의 비디오 다운로드를 시작합니다...`, 'info')
                
                // 각 비디오를 순차적으로 다운로드
                for (const url of urls) {
                    const videoId = extractVideoIdFromUrl(url)
                    const title = `Video_${videoId}`
                    
                    if (videoId) {
                        await downloadSingleVideo(videoId, title)
                        await new Promise(resolve => setTimeout(resolve, 1000)) // 1초 대기
                    }
                }
                
                // 선택 초기화
                selectedVideos.clear()
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false)
                updateSelectionStatus()
                
                showAlert('모든 다운로드가 완료되었습니다!', 'success')
            } catch (error) {
                console.error('Download error:', error)
                showAlert('다운로드 중 오류가 발생했습니다: ' + error.message, 'danger')
            }
        }
        
        // URL에서 비디오 ID 추출
        function extractVideoIdFromUrl(url) {
            try {
                const patterns = [
                    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
                    /youtube\.com\/watch\?.*v=([^&\n?#]+)/
                ]
                
                for (const pattern of patterns) {
                    const match = url.match(pattern)
                    if (match && match[1]) {
                        return match[1]
                    }
                }
                
                return null
            } catch (error) {
                console.error('Extract video ID error:', error)
                return null
            }
        }

        // 히스토리 표시
        function showUserHistory() {
            if (!currentUser) {
                showAlert('로그인이 필요합니다.', 'warning')
                return
            }
            showAlert('히스토리 기능은 준비 중입니다.', 'info')
        }

        // 즐겨찾기 표시
        function showUserFavorites() {
            if (!currentUser) {
                showAlert('로그인이 필요합니다.', 'warning')
                return
            }
            showAlert('즐겨찾기 기능은 준비 중입니다.', 'info')
        }

        // 로딩 표시
        function showLoading(show) {
            const loadingSection = document.getElementById('loadingSection')
            const resultsSection = document.getElementById('resultsSection')
            
            if (show) {
                loadingSection.style.display = 'block'
                resultsSection.style.display = 'none'
            } else {
                loadingSection.style.display = 'none'
                resultsSection.style.display = 'block'
            }
        }

        // 알림 표시
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer')
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `
            alertContainer.innerHTML = alertHtml
            
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert')
                if (alert) {
                    alert.remove()
                }
            }, 5000)
        }

        // Enter 키로 검색
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchVideos()
            }
        })

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            updateUserInterface()
        })
    </script>
</body>
</html>
