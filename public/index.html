<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Downloader - Supabase</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* ì„¸ë ¨ëœ ë””ìì¸ */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .btn {
            border-radius: 25px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }
        
        .btn-outline-primary {
            border: 2px solid #667eea;
            color: #667eea;
        }
        
        .btn-outline-primary:hover {
            background: #667eea;
            color: white;
        }
        
        .form-control {
            border-radius: 25px;
            border: 2px solid #e9ecef;
            padding: 20px 30px;
            font-size: 18px;
            height: 60px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .video-item {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .video-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .video-item .card-body {
            padding: 20px;
        }
        
        .video-item img {
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .video-item:hover img {
            transform: scale(1.05);
        }
        
        .badge {
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .loading {
            padding: 40px;
        }
        
        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }
            
            .card {
                margin: 10px 0;
                padding: 15px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .input-group input {
                border-radius: 25px !important;
                margin-bottom: 10px;
            }
            
            .input-group button {
                border-radius: 25px !important;
                width: 100%;
            }
            
            .btn-group {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .btn {
                margin-bottom: 5px;
                border-radius: 25px;
            }
            
            .row {
                margin: 0;
            }
            
            .col-md-6 {
                padding: 5px;
            }
            
            .video-item .row {
                flex-direction: column;
            }
            
            .video-item .col-md-3,
            .video-item .col-md-7,
            .video-item .col-md-2 {
                width: 100%;
                margin-bottom: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .form-control {
                font-size: 20px;
                padding: 25px 35px;
                height: 70px;
                border-radius: 35px;
            }
            
            .btn {
                padding: 20px 30px;
                font-size: 18px;
                height: 70px;
                border-radius: 35px;
            }
            
            .input-group {
                margin-bottom: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .card {
                margin: 5px 0;
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .form-control {
                font-size: 22px;
                padding: 30px 40px;
                height: 80px;
                border-radius: 40px;
            }
            
            .btn {
                padding: 25px 35px;
                font-size: 20px;
                height: 80px;
                border-radius: 40px;
            }
            
            .input-group {
                margin-bottom: 25px;
            }
            
            .input-group input {
                font-size: 22px;
                padding: 30px 40px;
                height: 80px;
                border-radius: 40px;
            }
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: none;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
        }
        .video-card {
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            background: white;
        }
        .video-card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transform: translateY(-3px);
        }
        .video-thumbnail {
            width: 120px;
            height: 90px;
            object-fit: cover;
            border-radius: 10px;
        }
        .user-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        .loading {
            display: none;
        }
        .alert {
            border-radius: 15px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- í—¤ë” -->
        <div class="text-center mb-5">
            <h1 class="display-4 text-white mb-3">
                <i class="fab fa-youtube text-danger me-3"></i>
                YouTube Downloader
            </h1>
            <p class="lead text-white-50">Supabase ê¸°ë°˜ í´ë¼ìš°ë“œ ë‹¤ìš´ë¡œë”</p>
        </div>

        <!-- ì‚¬ìš©ì ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="user-section">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div id="userInfo" style="display: none;">
                        <div class="d-flex align-items-center text-white">
                            <i class="fas fa-user-circle me-3" style="font-size: 2rem;"></i>
                            <div>
                                <div class="fw-bold" id="userName">ì‚¬ìš©ìëª…</div>
                                <small id="userEmail">user@example.com</small>
                            </div>
                        </div>
                    </div>
                    <div id="loginForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <input type="email" id="userEmailInput" class="form-control mb-3" 
                                           placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
                                </div>
                                <div class="mb-3">
                                    <input type="password" id="userPasswordInput" class="form-control mb-3" 
                                           placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                                </div>
                                <div class="mb-3">
                                    <button class="btn btn-primary w-100" type="button" onclick="loginUser()">
                                        <i class="fas fa-sign-in-alt me-2"></i>ë¡œê·¸ì¸
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-white">
                                    <small>ì‚¬ì „ ë“±ë¡ëœ ì‚¬ìš©ìë§Œ ë¡œê·¸ì¸ ê°€ëŠ¥</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-light btn-sm" onclick="showUserHistory()" id="historyBtn" disabled>
                            <i class="fas fa-history me-1"></i>íˆìŠ¤í† ë¦¬
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="showUserFavorites()" id="favoritesBtn" disabled>
                            <i class="fas fa-star me-1"></i>ì¦ê²¨ì°¾ê¸°
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="showSettings()" id="settingsBtn" disabled>
                            <i class="fas fa-cog me-1"></i>ì„¤ì •
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="logoutUser()" id="logoutBtn" style="display: none;">
                            <i class="fas fa-sign-out-alt me-1"></i>ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ê²€ìƒ‰ ì„¹ì…˜ -->
        <div class="card mb-4">
            <div class="card-body p-4">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" id="searchInput" class="form-control" 
                                   placeholder="ìœ íŠœë¸Œ URL ë˜ëŠ” ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                            <button class="btn btn-primary" type="button" onclick="searchVideos()">
                                <i class="fas fa-search me-2"></i>ê²€ìƒ‰
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-success w-100" onclick="downloadSelected()">
                            <i class="fas fa-download me-2"></i>ì„ íƒ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¡œë”© í‘œì‹œ -->
        <div class="loading text-center" id="loadingSection">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
            </div>
            <p class="mt-2 text-white">ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <div class="card" id="resultsSection" style="display: none;">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">
                        <i class="fas fa-list me-2"></i>ê²€ìƒ‰ ê²°ê³¼
                        <span class="badge bg-primary ms-2" id="resultCount">0</span>
                    </h3>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-success btn-sm" onclick="selectAllVideos()">
                            <i class="fas fa-check-square me-1"></i>ì „ì²´ ì„ íƒ
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="deselectAllVideos()">
                            <i class="fas fa-square me-1"></i>ì „ì²´ í•´ì œ
                        </button>
                    </div>
                </div>
                
                <!-- ì •ë ¬ ì˜µì…˜ -->
                <div class="mb-3">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary btn-sm" onclick="changeSortOrder('relevance')">
                            <i class="fas fa-star me-1"></i>ê´€ë ¨ì„±
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="changeSortOrder('duration-asc')">
                            <i class="fas fa-arrow-up me-1"></i>ì‹œê°„ ì§§ì€ ìˆœ
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="changeSortOrder('duration-desc')">
                            <i class="fas fa-arrow-down me-1"></i>ì‹œê°„ ê¸´ ìˆœ
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="changeSortOrder('viewCount')">
                            <i class="fas fa-eye me-1"></i>ì¡°íšŒìˆ˜ ìˆœ
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="changeSortOrder('date')">
                            <i class="fas fa-calendar me-1"></i>ìµœì‹ ìˆœ
                        </button>
                    </div>
                </div>
                <div id="videoResults"></div>
                
                <!-- í˜ì´ì§• ì»¨í…Œì´ë„ˆ -->
                <div id="paginationContainer" class="mt-4"></div>
            </div>
        </div>

        <!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
        <div id="alertContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://qhrfefcthrogwdwpxkby.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFocmZlZmN0aHJvZ3dkd3B4a2J5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTg1ODUsImV4cCI6MjA3NTM5NDU4NX0.Do9gajWdwgP8PFSlajAUhZHb024nfNZNnx1IJz9yR5k'
        
        // ì „ì—­ ë³€ìˆ˜
        let selectedVideos = new Set()
        let currentUser = null
        let searchResults = []
        let currentSortOrder = 'relevance' // ê¸°ë³¸ê°’: ê´€ë ¨ì„±
        let currentPage = 1
        let currentQuery = ''
        let paginationInfo = null
        
        // ì‚¬ìš©ì ì„¤ì • (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°)
        let userSettings = {
            defaultQuality: '720p', // ê¸°ë³¸ ë‹¤ìš´ë¡œë“œ í’ˆì§ˆ
            autoDownload: false,    // ìë™ ë‹¤ìš´ë¡œë“œ (ëª¨ë°”ì¼)
            showQualityDialog: true, // í’ˆì§ˆ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ ì—¬ë¶€
            downloadPath: '',       // ë‹¤ìš´ë¡œë“œ ê²½ë¡œ (ë¸Œë¼ìš°ì € ê¸°ë³¸ê°’ ì‚¬ìš©)
            askDownloadPath: false  // ë‹¤ìš´ë¡œë“œ ì‹œ ê²½ë¡œ ë¬»ê¸°
        }

        // ì‚¬ìš©ì ë¡œê·¸ì¸
        async function loginUser() {
            const email = document.getElementById('userEmailInput').value.trim()
            
            if (!email) {
                showAlert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning')
                return
            }
            
            try {
                const result = await callSupabaseAPI('/user/login', 'POST', { email, password: document.getElementById('userPasswordInput').value })
                
                if (result.success) {
                    currentUser = result.user
                    updateUserInterface()
                    showAlert(`í™˜ì˜í•©ë‹ˆë‹¤, ${result.user.name}ë‹˜!`, 'success')
                } else {
                    showAlert(result.error || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error')
                }
            } catch (error) {
                console.error('Login error:', error)
                showAlert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error')
            }
        }
        
        // ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        function loadUserSettings() {
            const saved = localStorage.getItem('youtubeDownloaderSettings')
            if (saved) {
                userSettings = { ...userSettings, ...JSON.parse(saved) }
            }
        }
        
        // ì„¤ì • ì €ì¥
        function saveUserSettings() {
            localStorage.setItem('youtubeDownloaderSettings', JSON.stringify(userSettings))
        }
        
        // ì„¤ì • í™”ë©´ í‘œì‹œ
        function showSettings() {
            loadUserSettings()
            
            const settingsHtml = `
                <div class="modal fade" id="settingsModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-cog me-2"></i>ë‹¤ìš´ë¡œë“œ ì„¤ì •
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">ê¸°ë³¸ ë‹¤ìš´ë¡œë“œ í’ˆì§ˆ</label>
                                    <select class="form-select" id="defaultQuality">
                                        <option value="720p" ${userSettings.defaultQuality === '720p' ? 'selected' : ''}>720p (HD) - ì¶”ì²œ</option>
                                        <option value="480p" ${userSettings.defaultQuality === '480p' ? 'selected' : ''}>480p (SD) - ë°ì´í„° ì ˆì•½</option>
                                        <option value="360p" ${userSettings.defaultQuality === '360p' ? 'selected' : ''}>360p (ë‚®ì€ í’ˆì§ˆ)</option>
                                        <option value="audio" ${userSettings.defaultQuality === 'audio' ? 'selected' : ''}>Audio (ìŒì„±ë§Œ)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="autoDownload" ${userSettings.autoDownload ? 'checked' : ''}>
                                        <label class="form-check-label" for="autoDownload">
                                            ğŸ“± ëª¨ë°”ì¼ì—ì„œ ìë™ ë‹¤ìš´ë¡œë“œ (í’ˆì§ˆ ì„ íƒ ì—†ì´)
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showQualityDialog" ${userSettings.showQualityDialog ? 'checked' : ''}>
                                        <label class="form-check-label" for="showQualityDialog">
                                            í’ˆì§ˆ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">ë‹¤ìš´ë¡œë“œ ê²½ë¡œ ì„¤ì •</label>
                                    <div class="alert alert-success">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <strong>ì„œë²„ ì‚¬ì´ë“œ ë‹¤ìš´ë¡œë“œ:</strong> ì´ì œ ì„œë²„ì—ì„œ ì§ì ‘ ë‹¤ìš´ë¡œë“œí•˜ë¯€ë¡œ í´ë”ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
                                    </div>
                                    <div class="mb-3">
                                        <label for="downloadPath" class="form-label">ë‹¤ìš´ë¡œë“œ í´ë” ê²½ë¡œ</label>
                                        <input type="text" class="form-control" id="downloadPath" 
                                               placeholder="ì˜ˆ: C:\Downloads\YouTube" 
                                               value="${userSettings.downloadPath || ''}">
                                        <div class="form-text">
                                            <strong>Windows:</strong> C:\Downloads\YouTube<br>
                                            <strong>Mac:</strong> /Users/username/Downloads/YouTube<br>
                                            <strong>Linux:</strong> /home/username/Downloads/YouTube
                                        </div>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="askDownloadPath" ${userSettings.askDownloadPath ? 'checked' : ''}>
                                        <label class="form-check-label" for="askDownloadPath">
                                            ë‹¤ìš´ë¡œë“œ ì‹œ ê²½ë¡œ í™•ì¸ ë©”ì‹œì§€ í‘œì‹œ
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>ëª¨ë°”ì¼ ìµœì í™”:</strong> ìë™ ë‹¤ìš´ë¡œë“œë¥¼ í™œì„±í™”í•˜ë©´ ëª¨ë°”ì¼ì—ì„œ í’ˆì§ˆ ì„ íƒ ì—†ì´ ë°”ë¡œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                                <button type="button" class="btn btn-primary" onclick="saveSettings()">ì €ì¥</button>
                            </div>
                        </div>
                    </div>
                </div>
            `
            
            // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
            const existingModal = document.getElementById('settingsModal')
            if (existingModal) {
                existingModal.remove()
            }
            
            // ìƒˆ ëª¨ë‹¬ ì¶”ê°€
            document.body.insertAdjacentHTML('beforeend', settingsHtml)
            
            // ëª¨ë‹¬ í‘œì‹œ
            const modal = new bootstrap.Modal(document.getElementById('settingsModal'))
            modal.show()
        }
        
        // ì„¤ì • ì €ì¥
        function saveSettings() {
            userSettings.defaultQuality = document.getElementById('defaultQuality').value
            userSettings.autoDownload = document.getElementById('autoDownload').checked
            userSettings.showQualityDialog = document.getElementById('showQualityDialog').checked
            userSettings.askDownloadPath = document.getElementById('askDownloadPath').checked
            userSettings.downloadPath = document.getElementById('downloadPath').value
            
            saveUserSettings()
            
            // ëª¨ë‹¬ ë‹«ê¸°
            const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'))
            modal.hide()
            
            showAlert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
        }
        
        // ISO 8601 durationì„ ì´ˆë¡œ ë³€í™˜
        function parseDuration(duration) {
            const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/)
            if (!match) return 0
            
            const hours = (match[1] || '0H').replace('H', '')
            const minutes = (match[2] || '0M').replace('M', '')
            const seconds = (match[3] || '0S').replace('S', '')
            
            return parseInt(hours) * 3600 + parseInt(minutes) * 60 + parseInt(seconds)
        }
        
        // ì´ˆë¥¼ "HH:MM:SS" ë˜ëŠ” "MM:SS" í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600)
            const minutes = Math.floor((seconds % 3600) / 60)
            const secs = seconds % 60
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`
            }
        }
        
        // ì¡°íšŒìˆ˜ í¬ë§·
        function formatViewCount(count) {
            if (count >= 100000000) return `${(count / 100000000).toFixed(1)}ì–µ`
            if (count >= 10000) return `${(count / 10000).toFixed(1)}ë§Œ`
            return count.toLocaleString()
        }

        // Supabase Edge Function API í˜¸ì¶œ
        async function callSupabaseAPI(endpoint, method = 'GET', data = null) {
            // Edge Function ì´ë¦„: 'youtube-downloader' ë˜ëŠ” ì‹¤ì œ ë°°í¬ëœ í•¨ìˆ˜ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
            const functionName = 'youtube-downloader' // â† Supabase ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•œ ì‹¤ì œ í•¨ìˆ˜ ì´ë¦„
            const url = `${SUPABASE_URL}/functions/v1/${functionName}${endpoint}`
            
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            }
            
            if (data) {
                options.body = JSON.stringify(data)
            }
            
            try {
                const response = await fetch(url, options)
                const result = await response.json()
                
                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}`)
                }
                
                return result
            } catch (error) {
                console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error)
                return { error: error.message }
            }
        }

        // YouTube ê²€ìƒ‰
        async function searchVideos() {
            const query = document.getElementById('searchInput').value.trim()
            
            if (!query) {
                showAlert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning')
                return
            }
            
            showLoading(true)
            
            try {
                const result = await callSupabaseAPI('/search', 'POST', { query })
                
                if (result.success) {
                    displaySearchResults(result.videos)
                    showAlert(`${result.videos.length}ê°œì˜ ê²°ê³¼ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`, 'success')
                } else {
                    showAlert(result.error || 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error')
                }
            } catch (error) {
                showAlert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error')
            } finally {
                showLoading(false)
            }
        }

        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displaySearchResults(videos) {
            const resultsContainer = document.getElementById('videoResults')
            const resultCount = document.getElementById('resultCount')
            
            resultCount.textContent = videos.length
            
            resultsContainer.innerHTML = videos.map(video => `
                <div class="video-item card mb-3" data-video-id="${video.id}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <img src="${video.thumbnail}" class="img-fluid rounded" alt="${video.title}">
                            </div>
                            <div class="col-md-7">
                                <h5 class="card-title">${video.title}</h5>
                                <p class="card-text text-muted">${video.channel}</p>
                                <p class="card-text small">${video.description.substring(0, 100)}...</p>
                            </div>
                            <div class="col-md-2 text-end">
                                <div class="form-check mb-2">
                                    <input class="form-check-input video-checkbox" type="checkbox" value="${video.id}">
                                    <label class="form-check-label">ì„ íƒ</label>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" onclick="downloadSingleVideo('${video.id}', '${video.title}')">
                                    <i class="fas fa-download me-1"></i>ë‹¤ìš´ë¡œë“œ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')
            
            document.getElementById('resultsSection').style.display = 'block'
        }

        // ë‹¨ì¼ ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
        async function downloadSingleVideo(videoId, title) {
            try {
                showAlert(`${title} ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...`, 'info')
                
                // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
                const result = await callSupabaseAPI('/download-links', 'POST', { videoId })
                
                if (result.success) {
                    // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
                    await handleClientDownload(videoId, title, result.downloadLinks)
                } else {
                    showAlert(result.error || 'ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error')
                }
            } catch (error) {
                showAlert('ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error')
            }
        }

        // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
        async function handleClientDownload(videoId, title, downloadLinks) {
            try {
                // ëª¨ë°”ì¼ ê¸°ê¸° ê°ì§€
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                
                // ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
                loadUserSettings()
                
                let format
                
                if (isMobile && userSettings.autoDownload) {
                    // ëª¨ë°”ì¼ + ìë™ ë‹¤ìš´ë¡œë“œ ì„¤ì • ì‹œ
                    format = userSettings.defaultQuality
                    showAlert(`ğŸ“± ëª¨ë°”ì¼ ìµœì í™”: ${format} í’ˆì§ˆë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.`, 'info')
                } else if (userSettings.showQualityDialog) {
                    // í’ˆì§ˆ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
                    format = await showDownloadOptions()
                    
                    if (!format) {
                        showAlert('ë‹¤ìš´ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info')
                        return
                    }
                } else {
                    // ê¸°ë³¸ í’ˆì§ˆ ì‚¬ìš©
                    format = userSettings.defaultQuality
                    showAlert(`${format} í’ˆì§ˆë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.`, 'info')
                }
                
                // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„± (ì‹¤ì œë¡œëŠ” yt-dlp.js ë˜ëŠ” ë‹¤ë¥¸ ë°©ë²• ì‚¬ìš©)
                const downloadUrl = await generateDownloadUrl(videoId, format)
                
                if (downloadUrl) {
                    // ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ ì‹œì‘
                    startBrowserDownload(downloadUrl, title, format)
                    showAlert(`${title} ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success')
                } else {
                    showAlert('ë‹¤ìš´ë¡œë“œ ë§í¬ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error')
                }
                
            } catch (error) {
                console.error('Download error:', error)
                showAlert('ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error')
            }
        }

        // ë‹¤ìš´ë¡œë“œ ì˜µì…˜ ì„ íƒ (ëª¨ë°”ì¼ ìµœì í™”)
        function showDownloadOptions() {
            return new Promise((resolve) => {
                // ëª¨ë°”ì¼ ê¸°ê¸° ê°ì§€
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                
                if (isMobile) {
                    // ëª¨ë°”ì¼ì—ì„œëŠ” 720pë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì¶”ì²œ
                    const message = `ğŸ“± ëª¨ë°”ì¼ ìµœì í™” ë‹¤ìš´ë¡œë“œ í’ˆì§ˆì„ ì„ íƒí•˜ì„¸ìš”:

â­ 1. 720p (HD) - ì¶”ì²œ
  2. 480p (SD) - ë°ì´í„° ì ˆì•½  
  3. 360p (ë‚®ì€ í’ˆì§ˆ) - ë¹ ë¥¸ ë‹¤ìš´ë¡œë“œ
  4. Audio (ìŒì„±ë§Œ)

ğŸ’¡ ì¶”ì²œ: 720p (ëª¨ë°”ì¼ì—ì„œ ê°€ì¥ ì í•©)

ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (1-4, ì—”í„°=720p):`
                    
                    const choice = prompt(message)
                    
                    if (choice === '' || choice === null) {
                        // ì—”í„°ë§Œ ëˆ„ë¥´ë©´ 720p ê¸°ë³¸ ì„ íƒ
                        resolve('720p')
                    } else if (choice >= 1 && choice <= 4) {
                        const options = ['720p', '480p', '360p', 'audio']
                        resolve(options[choice - 1])
                    } else {
                        // ì˜ëª»ëœ ì…ë ¥ì´ë©´ 720p ê¸°ë³¸ ì„ íƒ
                        resolve('720p')
                    }
                } else {
                    // ë°ìŠ¤í¬í†±ì—ì„œëŠ” ê¸°ì¡´ ë°©ì‹
                    const choice = prompt(`ë‹¤ìš´ë¡œë“œ í’ˆì§ˆì„ ì„ íƒí•˜ì„¸ìš”:\n1. 720p\n2. 480p\n3. 360p\n4. Audio\n\në²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (1-4):`)
                    
                    if (choice && choice >= 1 && choice <= 4) {
                        const options = ['720p', '480p', '360p', 'audio']
                        resolve(options[choice - 1])
                    } else {
                        resolve(null)
                    }
                }
            })
        }

        // ë‹¤ìš´ë¡œë“œ URL ìƒì„± (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” yt-dlp.js ì‚¬ìš©)
        async function generateDownloadUrl(videoId, format) {
            try {
                // ì‹¤ì œë¡œëŠ” yt-dlp.js ë˜ëŠ” ë‹¤ë¥¸ ë°©ë²•ì„ ì‚¬ìš©í•´ì•¼ í•¨
                // ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œë¡œ YouTube URLì„ ë°˜í™˜
                const youtubeUrl = `https://www.youtube.com/watch?v=${videoId}`
                
                // yt-dlp.jsë¥¼ ì‚¬ìš©í•œ ë‹¤ìš´ë¡œë“œ URL ìƒì„±
                // ì´ ë¶€ë¶„ì€ ì‹¤ì œ yt-dlp.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© í•„ìš”
                
                return youtubeUrl
            } catch (error) {
                console.error('URL generation error:', error)
                return null
            }
        }

        // ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ ì‹œì‘ (ê°œì„ ëœ ë²„ì „)
        function startBrowserDownload(url, title, format) {
            try {
                // íŒŒì¼ëª… ìƒì„± (íŠ¹ìˆ˜ë¬¸ì ì œê±°)
                const cleanTitle = title.replace(/[^\w\s-ê°€-í£]/g, '').replace(/\s+/g, '_')
                const extension = format === 'audio' ? 'mp3' : 'mp4'
                const filename = `${cleanTitle}.${extension}`
                
                // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
                const a = document.createElement('a')
                a.href = url
                a.download = filename
                a.style.display = 'none'
                
                // DOMì— ì¶”ê°€í•˜ê³  í´ë¦­
                document.body.appendChild(a)
                a.click()
                document.body.removeChild(a)
                
                // ì„œë²„ ì‚¬ì´ë“œ ë‹¤ìš´ë¡œë“œë¡œ ë³€ê²½
                startServerDownload(videoId, title, format)
                
            } catch (error) {
                console.error('Download start error:', error)
                showAlert('ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error')
            }
        }

        // ì„œë²„ ì‚¬ì´ë“œ ë‹¤ìš´ë¡œë“œ ì‹œì‘
        async function startServerDownload(videoId, title, format) {
            try {
                // ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
                loadUserSettings()
                
                // ì„œë²„ì— ë‹¤ìš´ë¡œë“œ ìš”ì²­
                const response = await callSupabaseAPI('/download', 'POST', {
                    videoId: videoId,
                    format: format,
                    downloadPath: userSettings.downloadPath || ''
                })
                
                if (response.success) {
                    // ë‹¤ìš´ë¡œë“œ ì„±ê³µ
                    addToDownloadHistory(title, `https://www.youtube.com/watch?v=${videoId}`, format)
                    
                    if (userSettings.askDownloadPath) {
                        showAlert(`ğŸ“ ${title} ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ’¾ ì €ì¥ ìœ„ì¹˜: ${response.downloadPath || 'ê¸°ë³¸ í´ë”'}\n\nâœ… ì„œë²„ì—ì„œ ì§ì ‘ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì§€ì •í•œ í´ë”ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success')
                    } else {
                        showAlert(`ğŸ“ ${title} ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success')
                    }
                } else {
                    showAlert(`ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${response.error}`, 'error')
                }
                
            } catch (error) {
                console.error('Server download error:', error)
                showAlert('ì„œë²„ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error')
            }
        }

        // ë‹¤ìš´ë¡œë“œ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
        function addToDownloadHistory(title, url, format) {
            const history = JSON.parse(localStorage.getItem('downloadHistory') || '[]')
            history.unshift({
                title,
                url,
                format,
                timestamp: new Date().toISOString()
            })
            
            // ìµœëŒ€ 100ê°œê¹Œì§€ë§Œ ì €ì¥
            if (history.length > 100) {
                history.splice(100)
            }
            
            localStorage.setItem('downloadHistory', JSON.stringify(history))
        }



        // ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ
        function logoutUser() {
            currentUser = null
            updateUserInterface()
            showAlert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info')
        }

        // ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ì—…ë°ì´íŠ¸
        function updateUserInterface() {
            const userInfo = document.getElementById('userInfo')
            const loginForm = document.getElementById('loginForm')
            const userName = document.getElementById('userName')
            const userEmail = document.getElementById('userEmail')
            const historyBtn = document.getElementById('historyBtn')
            const favoritesBtn = document.getElementById('favoritesBtn')
            const logoutBtn = document.getElementById('logoutBtn')
            
            if (currentUser) {
                userInfo.style.display = 'block'
                loginForm.style.display = 'none'
                userName.textContent = currentUser.name
                userEmail.textContent = currentUser.email
                historyBtn.disabled = false
                favoritesBtn.disabled = false
                logoutBtn.style.display = 'inline-block'
            } else {
                userInfo.style.display = 'none'
                loginForm.style.display = 'block'
                historyBtn.disabled = true
                favoritesBtn.disabled = true
                logoutBtn.style.display = 'none'
            }
        }

        // ì •ë ¬ ë° ê²°ê³¼ í‘œì‹œ
        function sortAndDisplayResults() {
            let sortedVideos = [...searchResults]
            
            switch(currentSortOrder) {
                case 'duration-asc': // ì‹œê°„ ì§§ì€ ìˆœ
                    sortedVideos.sort((a, b) => a.durationSeconds - b.durationSeconds)
                    break
                case 'duration-desc': // ì‹œê°„ ê¸´ ìˆœ
                    sortedVideos.sort((a, b) => b.durationSeconds - a.durationSeconds)
                    break
                case 'viewCount': // ì¡°íšŒìˆ˜ ë†’ì€ ìˆœ
                    sortedVideos.sort((a, b) => b.view_count - a.view_count)
                    break
                case 'date': // ìµœì‹ ìˆœ
                    sortedVideos.sort((a, b) => new Date(b.publishedAt || 0) - new Date(a.publishedAt || 0))
                    break
                case 'relevance': // ê´€ë ¨ì„± (ê¸°ë³¸ê°’)
                default:
                    // APIê°€ ë°˜í™˜í•œ ìˆœì„œ ìœ ì§€
                    break
            }
            
            displayResults(sortedVideos)
        }
        
        // ì •ë ¬ ìˆœì„œ ë³€ê²½
        function changeSortOrder(order) {
            currentSortOrder = order
            sortAndDisplayResults()
        }
        
        // í˜ì´ì§€ ë³€ê²½
        async function changePage(page) {
            if (!currentQuery) return
            
            showLoading(true)
            try {
                const result = await callSupabaseAPI('/search', 'POST', { 
                    query: currentQuery, 
                    page: page, 
                    pageSize: 10 
                })
                
                if (result.success && result.videos) {
                    const videos = result.videos.map(video => ({
                        title: video.title,
                        duration: video.duration || 'PT0S',
                        durationSeconds: parseDuration(video.duration || 'PT0S'),
                        url: video.url,
                        thumbnail: video.thumbnail,
                        channel_title: video.channel,
                        view_count: video.viewCount || 0,
                        like_count: video.likeCount || 0,
                        comment_count: video.commentCount || 0,
                        id: video.id,
                        description: video.description
                    }))
                    
                    searchResults = videos
                    paginationInfo = result.pagination
                    currentPage = page
                    sortAndDisplayResults()
                    updatePaginationUI()
                } else {
                    showAlert(result.error || 'í˜ì´ì§€ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger')
                }
            } catch (error) {
                console.error('Page change error:', error)
                showAlert('í˜ì´ì§€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger')
            } finally {
                showLoading(false)
            }
        }
        
        // í˜ì´ì§• UI ì—…ë°ì´íŠ¸
        function updatePaginationUI() {
            const paginationContainer = document.getElementById('paginationContainer')
            if (!paginationInfo || !paginationContainer) return
            
            let html = '<nav aria-label="ê²€ìƒ‰ ê²°ê³¼ í˜ì´ì§€"><ul class="pagination justify-content-center">'
            
            // ì´ì „ í˜ì´ì§€ ë²„íŠ¼
            if (paginationInfo.hasPrevPage) {
                html += `<li class="page-item">
                    <button class="page-link" onclick="changePage(${currentPage - 1})">
                        <i class="fas fa-chevron-left"></i> ì´ì „
                    </button>
                </li>`
            } else {
                html += `<li class="page-item disabled">
                    <span class="page-link"><i class="fas fa-chevron-left"></i> ì´ì „</span>
                </li>`
            }
            
            // í˜ì´ì§€ ë²ˆí˜¸ë“¤
            const startPage = Math.max(1, currentPage - 2)
            const endPage = Math.min(Math.ceil(paginationInfo.totalResults / paginationInfo.pageSize), currentPage + 2)
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    html += `<li class="page-item active">
                        <span class="page-link">${i}</span>
                    </li>`
                } else {
                    html += `<li class="page-item">
                        <button class="page-link" onclick="changePage(${i})">${i}</button>
                    </li>`
                }
            }
            
            // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼
            if (paginationInfo.hasNextPage) {
                html += `<li class="page-item">
                    <button class="page-link" onclick="changePage(${currentPage + 1})">
                        ë‹¤ìŒ <i class="fas fa-chevron-right"></i>
                    </button>
                </li>`
            } else {
                html += `<li class="page-item disabled">
                    <span class="page-link">ë‹¤ìŒ <i class="fas fa-chevron-right"></i></span>
                </li>`
            }
            
            html += '</ul></nav>'
            
            // ì´ ê²°ê³¼ ìˆ˜ í‘œì‹œ
            html += `<div class="text-center mt-2">
                <small class="text-muted">
                    ì´ ${paginationInfo.totalResults.toLocaleString()}ê°œ ì¤‘ 
                    ${((currentPage - 1) * paginationInfo.pageSize) + 1}-${Math.min(currentPage * paginationInfo.pageSize, paginationInfo.totalResults)}ê°œ í‘œì‹œ
                </small>
            </div>`
            
            paginationContainer.innerHTML = html
        }
        
        // URLì¸ì§€ ê²€ìƒ‰ì–´ì¸ì§€ íŒë‹¨
        function isYouTubeUrl(text) {
            const patterns = [
                /^https?:\/\/(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)/,
                /^https?:\/\/youtube\.com\/watch\?.*v=/,
                /^https?:\/\/youtu\.be\//
            ]
            return patterns.some(pattern => pattern.test(text))
        }
        
        // URLì—ì„œ ë¹„ë””ì˜¤ ID ì¶”ì¶œ
        function extractVideoIdFromUrl(url) {
            try {
                const patterns = [
                    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
                    /youtube\.com\/watch\?.*v=([^&\n?#]+)/
                ]
                
                for (const pattern of patterns) {
                    const match = url.match(pattern)
                    if (match && match[1]) {
                        return match[1]
                    }
                }
                
                return null
            } catch (error) {
                console.error('Extract video ID error:', error)
                return null
            }
        }

        // ë¹„ë””ì˜¤ ê²€ìƒ‰
        async function searchVideos() {
            const query = document.getElementById('searchInput').value.trim()
            
            if (!query) {
                showAlert('ê²€ìƒ‰ì–´ ë˜ëŠ” URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning')
                return
            }

            if (!currentUser) {
                showAlert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning')
                return
            }

            showLoading(true)
            selectedVideos.clear()
            
            try {
                // URLì¸ì§€ ê²€ìƒ‰ì–´ì¸ì§€ íŒë‹¨
                if (isYouTubeUrl(query)) {
                    // URL ê²€ìƒ‰ - ë‹¨ì¼ ë¹„ë””ì˜¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    await searchByUrl(query)
                } else {
                    // ê²€ìƒ‰ì–´ ê²€ìƒ‰ - ì—¬ëŸ¬ ê²°ê³¼
                    await searchByQuery(query)
                }
            } catch (error) {
                console.error('Search error:', error)
                showAlert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger')
                displayResults([])
            } finally {
                showLoading(false)
            }
        }
        
        // URLë¡œ ê²€ìƒ‰ (ë‹¨ì¼ ë¹„ë””ì˜¤)
        async function searchByUrl(url) {
            try {
                const result = await callSupabaseAPI('/video-info', 'POST', { url })
                
                if (result.success && result.video) {
                    const video = result.video
                    const videoData = {
                        title: video.title,
                        duration: video.duration || 'PT0S',
                        durationSeconds: parseDuration(video.duration || 'PT0S'),
                        url: video.url,
                        thumbnail: video.thumbnail,
                        channel_title: video.channel,
                        view_count: video.viewCount || 0,
                        like_count: video.likeCount || 0,
                        comment_count: video.commentCount || 0,
                        id: video.id,
                        description: video.description
                    }
                    
                    searchResults = [videoData] // ë‹¨ì¼ ê²°ê³¼
                    paginationInfo = {
                        currentPage: 1,
                        pageSize: 1,
                        totalResults: 1,
                        hasNextPage: false,
                        hasPrevPage: false
                    }
                    currentPage = 1
                    currentQuery = url
                    
                    displayResults([videoData])
                    updatePaginationUI()
                    showAlert('ë¹„ë””ì˜¤ ì •ë³´ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.', 'success')
                } else {
                    showAlert(result.error || 'ë¹„ë””ì˜¤ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'danger')
                    displayResults([])
                }
            } catch (error) {
                console.error('URL search error:', error)
                showAlert('URL ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger')
                displayResults([])
            }
        }
        
        // ê²€ìƒ‰ì–´ë¡œ ê²€ìƒ‰ (ì—¬ëŸ¬ ê²°ê³¼)
        async function searchByQuery(query) {
            try {
                currentQuery = query
                currentPage = 1
                const result = await callSupabaseAPI('/search', 'POST', { query, page: 1, pageSize: 10 })
                
                if (result.success && result.videos) {
                    // API ì‘ë‹µ í˜•ì‹ì„ displayResults í•¨ìˆ˜ì— ë§ê²Œ ë³€í™˜
                    const videos = result.videos.map(video => ({
                        title: video.title,
                        duration: video.duration || 'PT0S', // ISO 8601 í˜•ì‹
                        durationSeconds: parseDuration(video.duration || 'PT0S'), // ì •ë ¬ìš©
                        url: video.url,
                        thumbnail: video.thumbnail,
                        channel_title: video.channel,
                        view_count: video.viewCount || 0, // ìˆ«ìë¡œ ì €ì¥
                        like_count: video.likeCount || 0, // ì¢‹ì•„ìš” ìˆ˜
                        comment_count: video.commentCount || 0, // ëŒ“ê¸€ ìˆ˜
                        id: video.id,
                        description: video.description
                    }))
                    
                    searchResults = videos
                    paginationInfo = result.pagination
                    sortAndDisplayResults()
                    updatePaginationUI()
                    showAlert(`${videos.length}ê°œì˜ ê²°ê³¼ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`, 'success')
                } else {
                    showAlert(result.error || 'ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger')
                    displayResults([])
                }
            } catch (error) {
                console.error('Search error:', error)
                showAlert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger')
                displayResults([])
            }
        }

        // ê²°ê³¼ í‘œì‹œ
        function displayResults(results) {
            const videoResults = document.getElementById('videoResults')
            const resultCount = document.getElementById('resultCount')
            
            resultCount.textContent = results.length
            
            if (results.length === 0) {
                videoResults.innerHTML = '<p class="text-muted text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                return
            }

            let html = ''
            results.forEach((video, index) => {
                const isSelected = selectedVideos.has(video.url)
                
                html += `
                    <div class="video-card">
                        <div class="row align-items-center">
                            <div class="col-md-1">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="video${index}" value="${video.url}"
                                           ${isSelected ? 'checked' : ''}
                                           onchange="toggleVideoSelection('${video.url}')">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <img src="${video.thumbnail}" alt="ì¸ë„¤ì¼" class="video-thumbnail">
                            </div>
                            <div class="col-md-7">
                                <h5 class="mb-2">${video.title}</h5>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-user me-2"></i>${video.channel_title}
                                        </p>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-clock me-2"></i>${formatDuration(video.durationSeconds)}
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-eye me-2"></i>${formatViewCount(video.view_count)} ì¡°íšŒ
                                        </p>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-thumbs-up me-2"></i>${formatViewCount(video.like_count)} ì¢‹ì•„ìš”
                                        </p>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-comments me-2"></i>${formatViewCount(video.comment_count)} ëŒ“ê¸€
                                        </p>
                                    </div>
                                </div>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-link me-2"></i>
                                    <a href="${video.url}" target="_blank" class="text-decoration-none">
                                        ${video.url}
                                    </a>
                                </p>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-outline-primary btn-sm" 
                                        onclick="downloadSingle('${video.url}')">
                                    <i class="fas fa-download me-1"></i>ë‹¤ìš´ë¡œë“œ
                                </button>
                            </div>
                        </div>
                    </div>
                `
            })
            
            videoResults.innerHTML = html
            updateSelectionStatus()
        }

        // ë¹„ë””ì˜¤ ì„ íƒ í† ê¸€
        function toggleVideoSelection(url) {
            if (selectedVideos.has(url)) {
                selectedVideos.delete(url)
            } else {
                selectedVideos.add(url)
            }
            updateSelectionStatus()
        }

        // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSelectionStatus() {
            const selectedCount = selectedVideos.size
            const totalCount = document.querySelectorAll('input[type="checkbox"][id^="video"]').length
            
            const resultCount = document.getElementById('resultCount')
            if (selectedCount > 0) {
                resultCount.textContent = `${selectedCount}/${totalCount}`
                resultCount.className = 'badge bg-success ms-2'
            } else {
                resultCount.textContent = totalCount
                resultCount.className = 'badge bg-primary ms-2'
            }
        }

        // ì „ì²´ ì„ íƒ
        function selectAllVideos() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="video"]')
            checkboxes.forEach(checkbox => {
                if (checkbox.value) {
                    selectedVideos.add(checkbox.value)
                    checkbox.checked = true
                }
            })
            updateSelectionStatus()
            showAlert(`${checkboxes.length}ê°œ ë¹„ë””ì˜¤ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success')
        }

        // ì „ì²´ í•´ì œ
        function deselectAllVideos() {
            selectedVideos.clear()
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="video"]')
            checkboxes.forEach(checkbox => {
                checkbox.checked = false
            })
            updateSelectionStatus()
            showAlert('ëª¨ë“  ì„ íƒì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info')
        }

        // ì„ íƒëœ ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
        async function downloadSelected() {
            if (selectedVideos.size === 0) {
                showAlert('ë‹¤ìš´ë¡œë“œí•  ë¹„ë””ì˜¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning')
                return
            }

            const urls = Array.from(selectedVideos)
            await downloadVideos(urls)
        }

        // ë‹¨ì¼ ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
        async function downloadSingle(url) {
            await downloadVideos([url])
        }

        // ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ)
        async function downloadVideos(urls) {
            if (!currentUser) {
                showAlert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning')
                return
            }

            if (urls.length === 0) {
                showAlert('ë‹¤ìš´ë¡œë“œí•  ë¹„ë””ì˜¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning')
                return
            }

            try {
                showAlert(`${urls.length}ê°œì˜ ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...`, 'info')
                
                // ê° ë¹„ë””ì˜¤ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
                for (const url of urls) {
                    const videoId = extractVideoIdFromUrl(url)
                    const title = `Video_${videoId}`
                    
                    if (videoId) {
                        await downloadSingleVideo(videoId, title)
                        await new Promise(resolve => setTimeout(resolve, 1000)) // 1ì´ˆ ëŒ€ê¸°
                    }
                }
                
                // ì„ íƒ ì´ˆê¸°í™”
                selectedVideos.clear()
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false)
                updateSelectionStatus()
                
                showAlert('ëª¨ë“  ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success')
            } catch (error) {
                console.error('Download error:', error)
                showAlert('ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger')
            }
        }
        
        // URLì—ì„œ ë¹„ë””ì˜¤ ID ì¶”ì¶œ
        function extractVideoIdFromUrl(url) {
            try {
                const patterns = [
                    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
                    /youtube\.com\/watch\?.*v=([^&\n?#]+)/
                ]
                
                for (const pattern of patterns) {
                    const match = url.match(pattern)
                    if (match && match[1]) {
                        return match[1]
                    }
                }
                
                return null
            } catch (error) {
                console.error('Extract video ID error:', error)
                return null
            }
        }

        // íˆìŠ¤í† ë¦¬ í‘œì‹œ
        function showUserHistory() {
            if (!currentUser) {
                showAlert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning')
                return
            }
            showAlert('íˆìŠ¤í† ë¦¬ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.', 'info')
        }

        // ì¦ê²¨ì°¾ê¸° í‘œì‹œ
        function showUserFavorites() {
            if (!currentUser) {
                showAlert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning')
                return
            }
            showAlert('ì¦ê²¨ì°¾ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.', 'info')
        }

        // ë¡œë”© í‘œì‹œ
        function showLoading(show) {
            const loadingSection = document.getElementById('loadingSection')
            const resultsSection = document.getElementById('resultsSection')
            
            if (show) {
                loadingSection.style.display = 'block'
                resultsSection.style.display = 'none'
            } else {
                loadingSection.style.display = 'none'
                resultsSection.style.display = 'block'
            }
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer')
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `
            alertContainer.innerHTML = alertHtml
            
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert')
                if (alert) {
                    alert.remove()
                }
            }, 5000)
        }

        // Enter í‚¤ë¡œ ê²€ìƒ‰
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchVideos()
            }
        })

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            updateUserInterface()
        })
    </script>
</body>
</html>
