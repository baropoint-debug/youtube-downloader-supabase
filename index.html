<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Downloader - Supabase</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .card {
                margin: 10px 0;
                padding: 15px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .input-group input {
                border-radius: 25px !important;
                margin-bottom: 10px;
            }
            
            .input-group button {
                border-radius: 25px !important;
                width: 100%;
            }
            
            .btn-group {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .btn {
                margin-bottom: 5px;
                border-radius: 25px;
            }
            
            .row {
                margin: 0;
            }
            
            .col-md-6 {
                padding: 5px;
            }
        }
        
        @media (max-width: 480px) {
            .card {
                margin: 5px 0;
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .input-group input {
                font-size: 16px; /* 모바일에서 확대 방지 */
            }
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: none;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
        }
        .video-card {
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            background: white;
        }
        .video-card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transform: translateY(-3px);
        }
        .video-thumbnail {
            width: 120px;
            height: 90px;
            object-fit: cover;
            border-radius: 10px;
        }
        .user-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        .loading {
            display: none;
        }
        .alert {
            border-radius: 15px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- 헤더 -->
        <div class="text-center mb-5">
            <h1 class="display-4 text-white mb-3">
                <i class="fab fa-youtube text-danger me-3"></i>
                YouTube Downloader
            </h1>
            <p class="lead text-white-50">Supabase 기반 클라우드 다운로더</p>
        </div>

        <!-- 사용자 관리 섹션 -->
        <div class="user-section">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div id="userInfo" style="display: none;">
                        <div class="d-flex align-items-center text-white">
                            <i class="fas fa-user-circle me-3" style="font-size: 2rem;"></i>
                            <div>
                                <div class="fw-bold" id="userName">사용자명</div>
                                <small id="userEmail">user@example.com</small>
                            </div>
                        </div>
                    </div>
                    <div id="loginForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="input-group mb-2">
                                    <input type="email" id="userEmailInput" class="form-control" 
                                           placeholder="이메일을 입력하세요" style="border-radius: 25px 0 0 25px;">
                                    <input type="password" id="userPasswordInput" class="form-control" 
                                           placeholder="비밀번호를 입력하세요" style="border-radius: 0;">
                                    <button class="btn btn-primary" type="button" onclick="loginUser()" 
                                            style="border-radius: 0 25px 25px 0;">
                                        <i class="fas fa-sign-in-alt me-2"></i>로그인
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-white">
                                    <small>사전 등록된 사용자만 로그인 가능</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-light btn-sm" onclick="showUserHistory()" id="historyBtn" disabled>
                            <i class="fas fa-history me-1"></i>히스토리
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="showUserFavorites()" id="favoritesBtn" disabled>
                            <i class="fas fa-star me-1"></i>즐겨찾기
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="logoutUser()" id="logoutBtn" style="display: none;">
                            <i class="fas fa-sign-out-alt me-1"></i>로그아웃
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 메인 검색 섹션 -->
        <div class="card mb-4">
            <div class="card-body p-4">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" id="searchInput" class="form-control" 
                                   placeholder="유튜브 URL 또는 검색어를 입력하세요...">
                            <button class="btn btn-primary" type="button" onclick="searchVideos()">
                                <i class="fas fa-search me-2"></i>검색
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-success w-100" onclick="downloadSelected()">
                            <i class="fas fa-download me-2"></i>선택 다운로드
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 로딩 표시 -->
        <div class="loading text-center" id="loadingSection">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">로딩 중...</span>
            </div>
            <p class="mt-2 text-white">검색 중입니다...</p>
        </div>

        <!-- 결과 섹션 -->
        <div class="card" id="resultsSection" style="display: none;">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">
                        <i class="fas fa-list me-2"></i>검색 결과
                        <span class="badge bg-primary ms-2" id="resultCount">0</span>
                    </h3>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-success btn-sm" onclick="selectAllVideos()">
                            <i class="fas fa-check-square me-1"></i>전체 선택
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="deselectAllVideos()">
                            <i class="fas fa-square me-1"></i>전체 해제
                        </button>
                    </div>
                </div>
                <div id="videoResults"></div>
            </div>
        </div>

        <!-- 알림 메시지 -->
        <div id="alertContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Supabase 설정
        const SUPABASE_URL = 'https://qhrfefcthrogwdwpxkby.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFocmZlZmN0aHJvZ3dkd3B4a2J5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTg1ODUsImV4cCI6MjA3NTM5NDU4NX0.Do9gajWdwgP8PFSlajAUhZHb024nfNZNnx1IJz9yR5k'
        
        // 전역 변수
        let selectedVideos = new Set()
        let currentUser = null
        let searchResults = []

        // Supabase Edge Function API 호출
        async function callSupabaseAPI(endpoint, method = 'GET', data = null) {
            const url = `${SUPABASE_URL}/functions/v1/youtube-downloader${endpoint}`
            
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            }
            
            if (data) {
                options.body = JSON.stringify(data)
            }
            
            try {
                const response = await fetch(url, options)
                return await response.json()
            } catch (error) {
                console.error('API 호출 오류:', error)
                return { error: error.message }
            }
        }

        // 사용자 로그인
        async function loginUser() {
            const email = document.getElementById('userEmailInput').value.trim()
            
            if (!email) {
                showAlert('이메일을 입력해주세요.', 'warning')
                return
            }
            
            try {
                const result = await callSupabaseAPI('/user/login', 'POST', { email, password: document.getElementById('userPasswordInput').value })
                
                if (result.success) {
                    currentUser = result.user
                    updateUserInterface()
                    showAlert(`환영합니다, ${result.user.name}님!`, 'success')
                } else {
                    // 사용자가 없으면 자동 등록
                    await registerUser(email)
                }
            } catch (error) {
                showAlert('로그인 중 오류가 발생했습니다: ' + error.message, 'danger')
            }
        }

        // 사용자 등록
        async function registerUser(email) {
            try {
                const result = await callSupabaseAPI('/api/user/register', 'POST', { 
                    email, 
                    name: email.split('@')[0] 
                })
                
                if (result.success) {
                    currentUser = result.user
                    updateUserInterface()
                    showAlert(`새 계정이 생성되었습니다, ${result.user.name}님!`, 'success')
                } else {
                    showAlert(result.error, 'danger')
                }
            } catch (error) {
                showAlert('회원가입 중 오류가 발생했습니다: ' + error.message, 'danger')
            }
        }

        // 사용자 로그아웃
        function logoutUser() {
            currentUser = null
            updateUserInterface()
            showAlert('로그아웃되었습니다.', 'info')
        }

        // 사용자 인터페이스 업데이트
        function updateUserInterface() {
            const userInfo = document.getElementById('userInfo')
            const loginForm = document.getElementById('loginForm')
            const userName = document.getElementById('userName')
            const userEmail = document.getElementById('userEmail')
            const historyBtn = document.getElementById('historyBtn')
            const favoritesBtn = document.getElementById('favoritesBtn')
            const logoutBtn = document.getElementById('logoutBtn')
            
            if (currentUser) {
                userInfo.style.display = 'block'
                loginForm.style.display = 'none'
                userName.textContent = currentUser.name
                userEmail.textContent = currentUser.email
                historyBtn.disabled = false
                favoritesBtn.disabled = false
                logoutBtn.style.display = 'inline-block'
            } else {
                userInfo.style.display = 'none'
                loginForm.style.display = 'block'
                historyBtn.disabled = true
                favoritesBtn.disabled = true
                logoutBtn.style.display = 'none'
            }
        }

        // 비디오 검색
        async function searchVideos() {
            const query = document.getElementById('searchInput').value.trim()
            
            if (!query) {
                showAlert('검색어 또는 URL을 입력해주세요.', 'warning')
                return
            }

            showLoading(true)
            selectedVideos.clear()
            
            // 간단한 검색 시뮬레이션 (실제로는 YouTube API 연동 필요)
            const mockResults = [
                {
                    title: `검색 결과 1: ${query}`,
                    duration: '10:30',
                    url: 'https://www.youtube.com/watch?v=sample1',
                    thumbnail: 'https://via.placeholder.com/120x90',
                    channel_title: '채널명 1',
                    view_count: '1,234,567'
                },
                {
                    title: `검색 결과 2: ${query}`,
                    duration: '5:15',
                    url: 'https://www.youtube.com/watch?v=sample2',
                    thumbnail: 'https://via.placeholder.com/120x90',
                    channel_title: '채널명 2',
                    view_count: '987,654'
                }
            ]
            
            searchResults = mockResults
            displayResults(mockResults)
            showLoading(false)
        }

        // 결과 표시
        function displayResults(results) {
            const videoResults = document.getElementById('videoResults')
            const resultCount = document.getElementById('resultCount')
            
            resultCount.textContent = results.length
            
            if (results.length === 0) {
                videoResults.innerHTML = '<p class="text-muted text-center">검색 결과가 없습니다.</p>'
                return
            }

            let html = ''
            results.forEach((video, index) => {
                const isSelected = selectedVideos.has(video.url)
                
                html += `
                    <div class="video-card">
                        <div class="row align-items-center">
                            <div class="col-md-1">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="video${index}" value="${video.url}"
                                           ${isSelected ? 'checked' : ''}
                                           onchange="toggleVideoSelection('${video.url}')">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <img src="${video.thumbnail}" alt="썸네일" class="video-thumbnail">
                            </div>
                            <div class="col-md-7">
                                <h5 class="mb-2">${video.title}</h5>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-user me-2"></i>${video.channel_title}
                                        </p>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-clock me-2"></i>${video.duration}
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-eye me-2"></i>${video.view_count} 조회
                                        </p>
                                    </div>
                                </div>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-link me-2"></i>
                                    <a href="${video.url}" target="_blank" class="text-decoration-none">
                                        ${video.url}
                                    </a>
                                </p>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-outline-primary btn-sm" 
                                        onclick="downloadSingle('${video.url}')">
                                    <i class="fas fa-download me-1"></i>다운로드
                                </button>
                            </div>
                        </div>
                    </div>
                `
            })
            
            videoResults.innerHTML = html
            updateSelectionStatus()
        }

        // 비디오 선택 토글
        function toggleVideoSelection(url) {
            if (selectedVideos.has(url)) {
                selectedVideos.delete(url)
            } else {
                selectedVideos.add(url)
            }
            updateSelectionStatus()
        }

        // 선택 상태 업데이트
        function updateSelectionStatus() {
            const selectedCount = selectedVideos.size
            const totalCount = document.querySelectorAll('input[type="checkbox"][id^="video"]').length
            
            const resultCount = document.getElementById('resultCount')
            if (selectedCount > 0) {
                resultCount.textContent = `${selectedCount}/${totalCount}`
                resultCount.className = 'badge bg-success ms-2'
            } else {
                resultCount.textContent = totalCount
                resultCount.className = 'badge bg-primary ms-2'
            }
        }

        // 전체 선택
        function selectAllVideos() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="video"]')
            checkboxes.forEach(checkbox => {
                if (checkbox.value) {
                    selectedVideos.add(checkbox.value)
                    checkbox.checked = true
                }
            })
            updateSelectionStatus()
            showAlert(`${checkboxes.length}개 비디오가 선택되었습니다.`, 'success')
        }

        // 전체 해제
        function deselectAllVideos() {
            selectedVideos.clear()
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="video"]')
            checkboxes.forEach(checkbox => {
                checkbox.checked = false
            })
            updateSelectionStatus()
            showAlert('모든 선택이 해제되었습니다.', 'info')
        }

        // 선택된 비디오 다운로드
        async function downloadSelected() {
            if (selectedVideos.size === 0) {
                showAlert('다운로드할 비디오를 선택해주세요.', 'warning')
                return
            }

            const urls = Array.from(selectedVideos)
            await downloadVideos(urls)
        }

        // 단일 비디오 다운로드
        async function downloadSingle(url) {
            await downloadVideos([url])
        }

        // 비디오 다운로드
        async function downloadVideos(urls) {
            if (!currentUser) {
                showAlert('로그인이 필요합니다.', 'warning')
                return
            }

            try {
                const result = await callSupabaseAPI('/api/download', 'POST', {
                    urls: urls,
                    user_id: currentUser.id
                })

                if (result.success) {
                    showAlert(result.message, 'success')
                    selectedVideos.clear()
                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false)
                    updateSelectionStatus()
                } else {
                    showAlert(result.error, 'danger')
                }
            } catch (error) {
                showAlert('다운로드 중 오류가 발생했습니다: ' + error.message, 'danger')
            }
        }

        // 히스토리 표시
        function showUserHistory() {
            if (!currentUser) {
                showAlert('로그인이 필요합니다.', 'warning')
                return
            }
            showAlert('히스토리 기능은 준비 중입니다.', 'info')
        }

        // 즐겨찾기 표시
        function showUserFavorites() {
            if (!currentUser) {
                showAlert('로그인이 필요합니다.', 'warning')
                return
            }
            showAlert('즐겨찾기 기능은 준비 중입니다.', 'info')
        }

        // 로딩 표시
        function showLoading(show) {
            const loadingSection = document.getElementById('loadingSection')
            const resultsSection = document.getElementById('resultsSection')
            
            if (show) {
                loadingSection.style.display = 'block'
                resultsSection.style.display = 'none'
            } else {
                loadingSection.style.display = 'none'
                resultsSection.style.display = 'block'
            }
        }

        // 알림 표시
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer')
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `
            alertContainer.innerHTML = alertHtml
            
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert')
                if (alert) {
                    alert.remove()
                }
            }, 5000)
        }

        // Enter 키로 검색
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchVideos()
            }
        })

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            updateUserInterface()
        })
    </script>
</body>
</html>
